<!doctype html>
<html lang="ja">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>としまえんあたりのスタンプラリーご参加後アンケート</title>
<style>
body {
  font-family: system-ui,-apple-system,"Hiragino Kaku Gothic ProN",Meiryo,sans-serif;
  margin: 0; background: #f8fafc; color: #222;
}
.container {
  max-width: 900px; margin: 24px auto; padding: 16px;
}
.card {
  background: #fff; border-radius: 12px; padding: 24px;
  box-shadow: 0 2px 6px rgba(0,0,0,0.1);
}
h1 { font-size: 24px; margin-bottom: 20px; }
h2 { font-size: 18px; margin: 20px 0 8px; }
fieldset { border: none; margin: 0 0 16px; padding: 0; }
.grid {
  display: grid; grid-template-columns: repeat(auto-fit,minmax(240px,1fr));
  gap: 8px;
}
.help { font-size: 12px; color: #666; }
.error { color: #b00020; margin-top: 10px; }
button {
  background: #2563eb; color: white; border: none; border-radius: 6px;
  padding: 10px 16px; font-weight: 600; cursor: pointer;
}
button[disabled]{opacity: .6; cursor:not-allowed;}
.btn-secondary { background: #6b7280; }
.alert { background: #eef5ff; border: 1px solid #cfe0ff; border-radius: 8px; padding: 14px; margin: 10px 0; }
.hide { display: none !important; }
.checkgroup { max-height: 300px; overflow: auto; border: 1px solid #ddd; padding: 8px; border-radius: 8px; background: #fafafa; }
.required::after { content: " *"; color: #b00020; }
</style>
</head>
<body>
<div class="container">
  <div class="card">
    <h1>としまえんあたりのスタンプラリーご参加後アンケート</h1>

    <!-- ▼アンケートフォーム -->
    <div id="formView">
      <form id="surveyForm" novalidate>
        <fieldset>
          <h2 class="required">Q1：性別</h2>
          <label><input type="radio" name="q1_gender" value="男性" required> 男性</label><br>
          <label><input type="radio" name="q1_gender" value="女性"> 女性</label><br>
          <label><input type="radio" name="q1_gender" value="その他"> その他</label><br>
          <label><input type="radio" name="q1_gender" value="不明"> 不明</label>
        </fieldset>

        <fieldset>
          <h2 class="required">Q2：年代</h2>
          <div class="grid">
            <label><input type="radio" name="q2_age" value="10代以下" required>10代以下</label>
            <label><input type="radio" name="q2_age" value="20代">20代</label>
            <label><input type="radio" name="q2_age" value="30代">30代</label>
            <label><input type="radio" name="q2_age" value="40代">40代</label>
            <label><input type="radio" name="q2_age" value="50代">50代</label>
            <label><input type="radio" name="q2_age" value="60代">60代</label>
            <label><input type="radio" name="q2_age" value="70代以上">70代以上</label>
          </div>
        </fieldset>

        <fieldset>
          <h2 class="required">Q3：お住まいの郵便番号</h2>
          <input id="zip" name="q3_zip" maxlength="7" pattern="\\d{7}" required placeholder="例）1760001">
          <div class="help">半角数字7桁</div>
        </fieldset>

        <fieldset>
          <h2 class="required">Q4：お住まいの居住年数</h2>
          <div class="grid">
            <label><input type="radio" name="q4_years" value="1年未満" required>1年未満</label>
            <label><input type="radio" name="q4_years" value="1年~3年未満">1年~3年未満</label>
            <label><input type="radio" name="q4_years" value="3年~5年未満">3年~5年未満</label>
            <label><input type="radio" name="q4_years" value="5年~10年未満">5年~10年未満</label>
            <label><input type="radio" name="q4_years" value="10年以上">10年以上</label>
          </div>
        </fieldset>

        <fieldset>
          <h2 class="required">Q5：本スタンプラリー施策をどこで知りましたか？</h2>
          <div id="q5_group" class="grid"></div>
          <input type="hidden" id="q5_source" name="q5_source" required>
        </fieldset>

        <fieldset>
          <h2 class="required">Q6：はじめて行った店舗</h2>
          <div id="q6_group" class="checkgroup"></div>
          <div class="help">「なかった」を選ぶと他は自動で無効になります。</div>
        </fieldset>

        <fieldset>
          <h2 class="required">Q7：今後通いたい店舗</h2>
          <div id="q7_group" class="checkgroup"></div>
          <div class="help">「なかった」を選ぶと他は自動で無効になります。</div>
        </fieldset>

        <fieldset>
          <h2>Q8：今後参加したい地域施策・イベント（任意）</h2>
          <textarea name="q8_free" rows="5" placeholder="自由記述"></textarea>
        </fieldset>

        <div id="err" class="error"></div>

        <button id="submitBtn" type="submit">送信する</button>
        <button type="button" class="btn-secondary" onclick="location.reload()">入力をやり直す</button>
      </form>
      <div class="alert">※ 送信後、完了画面に回答番号が表示されます。</div>
    </div>

    <!-- ▼完了画面 -->
    <div id="thanksView" class="hide">
      <h2>ご回答ありがとうございました！</h2>
      <div class="alert">あなたは <b id="respNum">—</b> 番目の回答者です。</div>
      <button onclick="closeWindow()">ページを閉じる</button>
    </div>
  </div>
</div>

<script>
// ★ここを差し替え：googleusercontent の最終URL
const ENDPOINT = 'https://script.googleusercontent.com/macros/echo?user_content_key=AehSKLi1TrQLUpsBR09DVv5rlJtKSVqxugtQ-B5VQcPxghKF19s0uEHVMwD1jF_LKnop8fN3iBeohaCs1zepuAb0jR9CiOEXTue_GQl10mzgi75dwSdaBcyoUHYPwOBi8oDe9i9PSyRUY1rEmZWB4Rnxw0OvCbCEUk30jiHNw8b-sPjXizU9xr_GUBdQstQqY-SOwexp_dZDvNIzNGE8QTRMSRBbJp-jgVZMFpxACwJe-6HkfubV2fedcZMlKYnQOsoTbBn13mLkzFGuBDnuWLk9Aju_QckjdJlhK7sslw1Lw85D9jMTENU&lib=MyZphAQ8ILK4SXivHuEv2PojldFBKTi0l';

// 店舗リスト
const SHOPS = [
  'SNIP*SNIP','バールウギャッデ','笑天やきとり 一輝','夢民家','BBQ Records','111','デュアン漢方薬局',
  '猫カフェ えこねこ','titi cafe','としまえん 多喜','練馬区立 向山庭園','兄弟チキン','カーサ・デル・ヴィアッジアトーレ',
  'THE GIANT STEP','かすたねっと','豊島園 庭の湯','日本酒処 はち屋','タッポスト チャオラ','亀寿司','豊島園の夕陽',
  'アーバンオアシス タナカ','口水食堂','metro dinner.','その他店舗・施設','なかった'
];

function renderRadioGroup(id, list) {
  const wrap = document.getElementById(id);
  list.forEach(v => {
    const lbl = document.createElement('label');
    const r = document.createElement('input');
    r.type = 'radio'; r.name = id+'_r'; r.value = v;
    r.addEventListener('change',()=>document.getElementById('q5_source').value=v);
    lbl.append(r, ' ', v);
    wrap.append(lbl);
  });
}

function renderCheckGroup(id) {
  const wrap = document.getElementById(id);
  SHOPS.forEach(v=>{
    const lbl=document.createElement('label');
    const c=document.createElement('input');
    c.type='checkbox'; c.value=v;
    lbl.append(c,' ',v);
    wrap.append(lbl);
  });
  wrap.addEventListener('change',()=>{
    const checks=[...wrap.querySelectorAll('input[type=checkbox]')];
    const none=checks.find(c=>c.value==='なかった');
    if(none.checked){
      checks.forEach(c=>{ if(c!==none){c.checked=false;c.disabled=true;} });
    }else{
      checks.forEach(c=>c.disabled=false);
    }
  });
}

// 郵便番号制限
document.getElementById('zip').addEventListener('input',e=>{
  e.target.value=e.target.value.replace(/\D/g,'').slice(0,7);
});

// --- 送信(GET版) ---
document.getElementById('surveyForm').addEventListener('submit',async ev=>{
  ev.preventDefault(); setError('');
  const f=new FormData(ev.target);
  if(!f.get('q1_gender')||!f.get('q2_age')) return setError('必須項目を入力してください');
  if(!/^\d{7}$/.test(String(f.get('q3_zip')||''))) return setError('郵便番号は半角7桁');

  const q5=document.querySelector('input[name="q5_group_r"]:checked');
  const q6=getMulti('q6_group'); const q7=getMulti('q7_group');
  if(q6.length===0) return setError('Q6 を選択してください');
  if(q7.length===0) return setError('Q7 を選択してください');

  const params=new URLSearchParams();
  params.set('action','submit');
  params.set('q1_gender',f.get('q1_gender'));
  params.set('q2_age',f.get('q2_age'));
  params.set('q3_zip',f.get('q3_zip'));
  params.set('q4_years',f.get('q4_years'));
  params.set('q5_source',document.getElementById('q5_source').value);
  params.set('q6_firstStores',q6.join('|'));
  params.set('q7_futureStores',q7.join('|'));
  params.set('q8_free',f.get('q8_free')||'');

  const url=ENDPOINT+'&'+params.toString();
  const btn=document.getElementById('submitBtn'); btn.disabled=true;

  try{
    const res=await fetch(url,{method:'GET',cache:'no-store'});
    const js=await res.json().catch(()=>({}));
    if(js.ok && typeof js.number==='number'){
      sessionStorage.setItem('lastNumber',js.number);
      showThanks(js.number);
    }else{
      throw new Error('送信エラー');
    }
  }catch(e){
    console.error(e);
    setError('通信エラー：'+e.message);
  }finally{
    btn.disabled=false;
  }
});

function getMulti(id){
  const c=[...document.getElementById(id).querySelectorAll('input[type=checkbox]')];
  const none=c.find(x=>x.value==='なかった');
  if(none&&none.checked) return ['なかった'];
  return c.filter(x=>x.checked&&x.value!=='なかった').map(x=>x.value);
}

function setError(msg){document.getElementById('err').textContent=msg;}
function showThanks(n){
  document.getElementById('respNum').textContent=n;
  document.getElementById('formView').classList.add('hide');
  document.getElementById('thanksView').classList.remove('hide');
}
function closeWindow(){window.close();location.replace('about:blank');}

// 初期描画
renderRadioGroup('q5_group',['ポスター','SNS','チラシ','店頭','その他']);
renderCheckGroup('q6_group'); renderCheckGroup('q7_group');
</script>
</body>
</html>
